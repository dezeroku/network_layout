#!/usr/bin/env bash

# Just run `vagrant_build <command you want to run remotely>`
# e.g. `vagrant_build ls`
# Remember that you need to do the proper escapes

set -euxo pipefail

RUNDIR="$(readlink -f "$(dirname "$0")")"

pushd "${RUNDIR}"
ssh_config="$(mktemp)"
vagrant ssh-config >"${ssh_config}"

pushd "${RUNDIR}/../.."

# Sync everything from local working dir
rsync -e "ssh -F ${ssh_config}" -v --mkpath -aR --delete --exclude "build/builds" ./ "default:/home/vagrant/network_layout/"

# shellcheck disable=SC2087
exec ssh -F "${ssh_config}" -tt "default" bash <<EOF
cd network_layout/build
$@
EOF
